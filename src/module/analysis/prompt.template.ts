export class PromptTemplate {
  static generateAnalysisPrompt(
    commitMessage: string,
    diff: string,
    files: FileChange[],
  ): string {
    const fileList = files
      .map((f) => `- ${f.filename} (${f.status})`)
      .join('\n');

    return `你是一位资深的代码审查专家。请对以下代码提交进行全面的分析，重点关注代码复杂度、可行性和安全性。请以 JSON 格式输出分析结果，其中 analysisReport 字段必须是格式优美的 Markdown 文档。

## 提交信息
提交信息: ${commitMessage}

## 变更文件
${fileList || '无文件变更信息'}

## 代码变更 (Diff)
\`\`\`
${diff || '无 diff 信息'}
\`\`\`

## 分析要求
请从以下维度对本次提交进行详细分析：

### 1. 代码复杂度分析
- 代码结构的复杂程度
- 是否存在过度复杂的逻辑
- 可读性和可维护性评估
- 建议的简化方案（如有）

### 2. 可行性评估
- 代码实现的合理性
- 是否存在潜在的逻辑错误
- 边界情况处理是否完善
- 性能考虑是否充分

### 3. 安全性检查
- 是否存在安全漏洞（如 SQL 注入、XSS、CSRF 等）
- 敏感信息处理是否安全
- 权限验证是否充分
- 输入验证是否完善

### 4. 总体评价
- 综合评分和建议
- 整体代码质量评估

### 5. 行级评论
如果发现代码错误、潜在问题或需要改进的地方，请在 lineComments 数组中添加评论。每个评论需要包含：
- path: 文件路径
- line: 文件中的行号（用于显示）
- position: **diff 中的位置索引**（重要！这是 diff 中该行的位置，从 1 开始计数。需要根据 diff 内容计算，只计算实际代码行，不包括 diff 头部信息如 "---"、"+++"、行号标记等）
- comment: 具体的评论内容
- severity: 严重程度（"error" | "warning" | "info"）

**position 计算说明：**
- position 是 diff 中实际代码行的位置索引
- 从 diff 的第一行代码开始计数（不包括文件头、行号标记等）
- 例如：如果 diff 是：
  \`\`\`
  @@ -10,5 +10,6 @@
   line1
   line2
  +new line
  \`\`\`
  那么 "new line" 的 position 应该是 3（第 3 行实际代码）

## analysisReport 输出格式要求

**重要：analysisReport 必须使用格式优美的 Markdown 文档，包含以下元素：**

1. **使用表格展示评分和检查项**，例如：
   \`\`\`markdown
   | 维度 | 评分 | 状态 | 说明 |
   |------|------|------|------|
   | 复杂度 | ⭐⭐⭐⭐☆ | ✅ 良好 | 代码结构清晰，逻辑合理 |
   | 可行性 | ⭐⭐⭐⭐⭐ | ✅ 优秀 | 实现方案合理，边界处理完善 |
   | 安全性 | ⭐⭐⭐☆☆ | ⚠️ 需改进 | 缺少输入验证 |
   \`\`\`

2. **使用代码块展示关键代码片段**（如果涉及）

3. **使用引用块突出重要建议**，例如：
   \`\`\`markdown
   > ⚠️ **重要提醒**：建议添加输入验证，防止潜在的安全漏洞。
   \`\`\`

4. **使用列表和子标题组织内容**，保持层次清晰

5. **使用 emoji 增强可读性**（可选但推荐）：
   - ✅ 表示通过/良好
   - ⚠️ 表示警告/需改进
   - ❌ 表示错误/严重问题
   - 💡 表示建议
   - 🔒 表示安全性相关
   - 📊 表示数据/统计

6. **使用分隔线区分不同章节**

## JSON 输出格式示例

请严格按照以下 JSON 格式输出，**analysisReport 必须是格式优美的 Markdown 文档**：

\`\`\`json
{
  "analysisReport": "# 📋 代码审查报告\\n\\n---\\n\\n## 📊 综合评分\\n\\n| 维度 | 评分 | 状态 | 说明 |\\n|------|------|------|------|\\n| 复杂度 | ⭐⭐⭐⭐☆ | ✅ 良好 | 代码结构清晰，逻辑合理 |\\n| 可行性 | ⭐⭐⭐⭐⭐ | ✅ 优秀 | 实现方案合理，边界处理完善 |\\n| 安全性 | ⭐⭐⭐☆☆ | ⚠️ 需改进 | 缺少输入验证 |\\n\\n---\\n\\n## 🔍 代码复杂度分析\\n\\n### 评估结果\\n\\n- **代码结构**：整体结构清晰，模块划分合理\\n- **逻辑复杂度**：部分函数存在嵌套过深的问题\\n- **可读性**：变量命名规范，注释充分\\n\\n### 💡 改进建议\\n\\n> 建议将 \`processData\` 函数拆分为更小的函数，降低圈复杂度。\\n\\n---\\n\\n## ✅ 可行性评估\\n\\n### 实现合理性\\n\\n| 检查项 | 结果 | 说明 |\\n|--------|------|------|\\n| 逻辑正确性 | ✅ 通过 | 核心逻辑实现正确 |\\n| 边界处理 | ✅ 通过 | 已考虑边界情况 |\\n| 性能考虑 | ⚠️ 部分 | 大数据量时可能存在性能瓶颈 |\\n\\n### 潜在问题\\n\\n1. 缺少对空值的处理\\n2. 异常处理不够完善\\n\\n---\\n\\n## 🔒 安全性检查\\n\\n| 检查项 | 状态 | 风险等级 | 说明 |\\n|--------|------|----------|------|\\n| SQL 注入 | ✅ 安全 | - | 使用了参数化查询 |\\n| XSS 防护 | ⚠️ 需改进 | 中 | 缺少输出转义 |\\n| 输入验证 | ❌ 缺失 | 高 | 未对用户输入进行验证 |\\n| 权限验证 | ✅ 安全 | - | 权限检查完善 |\\n\\n### 安全建议\\n\\n> 🔒 **重要**：建议添加输入验证和输出转义，防止 XSS 攻击。\\n\\n---\\n\\n## 📝 总体评价\\n\\n### 综合评分：⭐⭐⭐⭐☆ (4/5)\\n\\n**优点：**\\n- 代码结构清晰，逻辑合理\\n- 核心功能实现正确\\n\\n**需要改进：**\\n- 加强安全性防护\\n- 优化性能瓶颈\\n\\n**建议：**\\n1. 添加输入验证和输出转义\\n2. 优化大数据量处理逻辑\\n3. 完善异常处理机制\\n",
  "lineComments": [
    {
      "path": "src/example.ts",
      "line": 42,
      "position": 15,
      "comment": "这里可能存在空指针异常，建议添加空值检查",
      "severity": "warning"
    }
  ]
}
\`\`\`

## 输出要求总结

1. **analysisReport 必须是格式优美的 Markdown 文档**，包含：
   - 使用表格展示评分和检查项
   - 使用代码块、引用块、列表等 Markdown 元素
   - 使用 emoji 增强可读性（可选）
   - 使用分隔线区分章节
   - 保持层次清晰，结构完整

2. **内容要求**：
   - 必须包含：复杂度分析、可行性评估、安全性检查、总体评价四个部分
   - 每个部分都要有具体的分析和建议
   - 使用表格、列表等格式让内容更易读

3. **如果代码没有问题，lineComments 可以为空数组 []**

4. **severity 只能是 "error"、"warning" 或 "info" 之一**

5. **请确保输出的 JSON 格式完全合法，可以被 JSON.parse() 解析**

6. **注意转义字符**：在 JSON 字符串中，换行符使用 \\n，引号使用 \\"`;
  }
}
