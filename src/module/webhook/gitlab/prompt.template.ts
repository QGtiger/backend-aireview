export class PromptTemplate {
  static generateAnalysisPrompt(
    commitMessage: string,
    diff: string,
    files: FileChange[],
  ): string {
    const fileList = files
      .map((f) => `- ${f.filename} (${f.status})`)
      .join('\n');

    return `ä½ æ˜¯ä¸€ä½èµ„æ·±çš„ä»£ç å®¡æŸ¥ä¸“å®¶ã€‚è¯·å¯¹ä»¥ä¸‹ä»£ç æäº¤è¿›è¡Œå…¨é¢çš„åˆ†æï¼Œé‡ç‚¹å…³æ³¨ä»£ç å¤æ‚åº¦ã€å¯è¡Œæ€§å’Œå®‰å…¨æ€§ã€‚è¯·ä»¥ JSON æ ¼å¼è¾“å‡ºåˆ†æç»“æœï¼Œå…¶ä¸­ analysisReport å­—æ®µå¿…é¡»æ˜¯æ ¼å¼ä¼˜ç¾çš„ Markdown æ–‡æ¡£ã€‚

## æäº¤ä¿¡æ¯
æäº¤ä¿¡æ¯: ${commitMessage}

## å˜æ›´æ–‡ä»¶
${fileList || 'æ— æ–‡ä»¶å˜æ›´ä¿¡æ¯'}

## ä»£ç å˜æ›´ (Diff)
\`\`\`
${diff || 'æ—  diff ä¿¡æ¯'}
\`\`\`

## åˆ†æè¦æ±‚
è¯·ä»ä»¥ä¸‹ç»´åº¦å¯¹æœ¬æ¬¡æäº¤è¿›è¡Œè¯¦ç»†åˆ†æï¼š

### 1. ä»£ç å¤æ‚åº¦åˆ†æ
- ä»£ç ç»“æ„çš„å¤æ‚ç¨‹åº¦
- æ˜¯å¦å­˜åœ¨è¿‡åº¦å¤æ‚çš„é€»è¾‘
- å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§è¯„ä¼°
- å»ºè®®çš„ç®€åŒ–æ–¹æ¡ˆï¼ˆå¦‚æœ‰ï¼‰

### 2. å¯è¡Œæ€§è¯„ä¼°
- ä»£ç å®ç°çš„åˆç†æ€§
- æ˜¯å¦å­˜åœ¨æ½œåœ¨çš„é€»è¾‘é”™è¯¯
- è¾¹ç•Œæƒ…å†µå¤„ç†æ˜¯å¦å®Œå–„
- æ€§èƒ½è€ƒè™‘æ˜¯å¦å……åˆ†

### 3. å®‰å…¨æ€§æ£€æŸ¥
- æ˜¯å¦å­˜åœ¨å®‰å…¨æ¼æ´ï¼ˆå¦‚ SQL æ³¨å…¥ã€XSSã€CSRF ç­‰ï¼‰
- æ•æ„Ÿä¿¡æ¯å¤„ç†æ˜¯å¦å®‰å…¨
- æƒé™éªŒè¯æ˜¯å¦å……åˆ†
- è¾“å…¥éªŒè¯æ˜¯å¦å®Œå–„

### 4. æ€»ä½“è¯„ä»·
- ç»¼åˆè¯„åˆ†å’Œå»ºè®®
- æ•´ä½“ä»£ç è´¨é‡è¯„ä¼°

### 5. è¡Œçº§è¯„è®º
å¦‚æœå‘ç°ä»£ç é”™è¯¯ã€æ½œåœ¨é—®é¢˜æˆ–éœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼Œè¯·åœ¨ lineComments æ•°ç»„ä¸­æ·»åŠ è¯„è®ºã€‚æ¯ä¸ªè¯„è®ºéœ€è¦åŒ…å«ï¼š
- path: æ–‡ä»¶è·¯å¾„
- line: æ–‡ä»¶ä¸­çš„è¡Œå·ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
- position: **diff ä¸­çš„ä½ç½®ç´¢å¼•**ï¼ˆé‡è¦ï¼è¿™æ˜¯ diff ä¸­è¯¥è¡Œçš„ä½ç½®ï¼Œä» 1 å¼€å§‹è®¡æ•°ã€‚éœ€è¦æ ¹æ® diff å†…å®¹è®¡ç®—ï¼Œåªè®¡ç®—å®é™…ä»£ç è¡Œï¼Œä¸åŒ…æ‹¬æ–‡ä»¶å¤´ã€è¡Œå·æ ‡è®°ç­‰ï¼‰
- comment: å…·ä½“çš„è¯„è®ºå†…å®¹
- severity: ä¸¥é‡ç¨‹åº¦ï¼ˆ"error" | "warning" | "info"ï¼‰

**position è®¡ç®—è¯´æ˜ï¼ˆGitLab æ ¼å¼ï¼‰ï¼š**
- position æ˜¯ diff ä¸­å®é™…ä»£ç è¡Œçš„ä½ç½®ç´¢å¼•
- ä» diff çš„ç¬¬ä¸€è¡Œä»£ç å¼€å§‹è®¡æ•°ï¼ˆä¸åŒ…æ‹¬æ–‡ä»¶å¤´ã€è¡Œå·æ ‡è®°ç­‰ï¼‰
- **éœ€è¦è·³è¿‡çš„è¡Œï¼š**
  - æ–‡ä»¶å¤´éƒ¨è¡Œï¼šä»¥ "æ–‡ä»¶ï¼š" å¼€å¤´çš„è¡Œï¼ˆå¦‚ "æ–‡ä»¶ï¼š33.md (modified)"ï¼‰
  - diff æ ‡è®°è¡Œï¼šä»¥ "@@" å¼€å¤´çš„è¡Œï¼ˆå¦‚ "@@ -1 +1 @@"ï¼‰
  - å…ƒæ•°æ®è¡Œï¼šä»¥ "\\" å¼€å¤´çš„è¡Œï¼ˆå¦‚ "\\ No newline at end of file"ï¼‰
  - ç©ºè¡Œ
- **éœ€è¦è®¡ç®—çš„è¡Œï¼š**
  - ä»¥ "+" å¼€å¤´çš„è¡Œï¼ˆæ–°å¢çš„ä»£ç è¡Œï¼‰
  - ä»¥ "-" å¼€å¤´çš„è¡Œï¼ˆåˆ é™¤çš„ä»£ç è¡Œï¼‰
  - ä¸Šä¸‹æ–‡è¡Œï¼ˆæ—¢ä¸æ˜¯ "+" ä¹Ÿä¸æ˜¯ "-" å¼€å¤´çš„å®é™…ä»£ç è¡Œï¼‰
- ä¾‹å¦‚ï¼šå¦‚æœ diff æ˜¯ï¼š
  \`\`\`
  æ–‡ä»¶ï¼šexample.ts (modified)
  @@ -1,3 +1,4 @@
   line1
   line2
  +new line
  \`\`\`
  é‚£ä¹ˆ "new line" çš„ position åº”è¯¥æ˜¯ 3ï¼ˆç¬¬ 3 è¡Œå®é™…ä»£ç ï¼Œè·³è¿‡äº†æ–‡ä»¶å¤´å’Œ @@ è¡Œï¼‰

## analysisReport è¾“å‡ºæ ¼å¼è¦æ±‚

**é‡è¦ï¼šanalysisReport å¿…é¡»ä½¿ç”¨æ ¼å¼ä¼˜ç¾çš„ Markdown æ–‡æ¡£ï¼ŒåŒ…å«ä»¥ä¸‹å…ƒç´ ï¼š**

1. **ä½¿ç”¨è¡¨æ ¼å±•ç¤ºè¯„åˆ†å’Œæ£€æŸ¥é¡¹**ï¼Œä¾‹å¦‚ï¼š
   \`\`\`markdown
   | ç»´åº¦ | è¯„åˆ† | çŠ¶æ€ | è¯´æ˜ |
   |------|------|------|------|
   | å¤æ‚åº¦ | â­â­â­â­â˜† | âœ… è‰¯å¥½ | ä»£ç ç»“æ„æ¸…æ™°ï¼Œé€»è¾‘åˆç† |
   | å¯è¡Œæ€§ | â­â­â­â­â­ | âœ… ä¼˜ç§€ | å®ç°æ–¹æ¡ˆåˆç†ï¼Œè¾¹ç•Œå¤„ç†å®Œå–„ |
   | å®‰å…¨æ€§ | â­â­â­â˜†â˜† | âš ï¸ éœ€æ”¹è¿› | ç¼ºå°‘è¾“å…¥éªŒè¯ |
   \`\`\`

2. **ä½¿ç”¨ä»£ç å—å±•ç¤ºå…³é”®ä»£ç ç‰‡æ®µ**ï¼ˆå¦‚æœæ¶‰åŠï¼‰

3. **ä½¿ç”¨å¼•ç”¨å—çªå‡ºé‡è¦å»ºè®®**ï¼Œä¾‹å¦‚ï¼š
   \`\`\`markdown
   > âš ï¸ **é‡è¦æé†’**ï¼šå»ºè®®æ·»åŠ è¾“å…¥éªŒè¯ï¼Œé˜²æ­¢æ½œåœ¨çš„å®‰å…¨æ¼æ´ã€‚
   \`\`\`

4. **ä½¿ç”¨åˆ—è¡¨å’Œå­æ ‡é¢˜ç»„ç»‡å†…å®¹**ï¼Œä¿æŒå±‚æ¬¡æ¸…æ™°

5. **ä½¿ç”¨ emoji å¢å¼ºå¯è¯»æ€§**ï¼ˆå¯é€‰ä½†æ¨èï¼‰ï¼š
   - âœ… è¡¨ç¤ºé€šè¿‡/è‰¯å¥½
   - âš ï¸ è¡¨ç¤ºè­¦å‘Š/éœ€æ”¹è¿›
   - âŒ è¡¨ç¤ºé”™è¯¯/ä¸¥é‡é—®é¢˜
   - ğŸ’¡ è¡¨ç¤ºå»ºè®®
   - ğŸ”’ è¡¨ç¤ºå®‰å…¨æ€§ç›¸å…³
   - ğŸ“Š è¡¨ç¤ºæ•°æ®/ç»Ÿè®¡

6. **ä½¿ç”¨åˆ†éš”çº¿åŒºåˆ†ä¸åŒç« èŠ‚**

## JSON è¾“å‡ºæ ¼å¼ç¤ºä¾‹

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¾“å‡ºï¼Œ**analysisReport å¿…é¡»æ˜¯æ ¼å¼ä¼˜ç¾çš„ Markdown æ–‡æ¡£**ï¼š

\`\`\`json
{
  "analysisReport": "# ğŸ“‹ ä»£ç å®¡æŸ¥æŠ¥å‘Š\\n\\n---\\n\\n## ğŸ“Š ç»¼åˆè¯„åˆ†\\n\\n| ç»´åº¦ | è¯„åˆ† | çŠ¶æ€ | è¯´æ˜ |\\n|------|------|------|------|\\n| å¤æ‚åº¦ | â­â­â­â­â˜† | âœ… è‰¯å¥½ | ä»£ç ç»“æ„æ¸…æ™°ï¼Œé€»è¾‘åˆç† |\\n| å¯è¡Œæ€§ | â­â­â­â­â­ | âœ… ä¼˜ç§€ | å®ç°æ–¹æ¡ˆåˆç†ï¼Œè¾¹ç•Œå¤„ç†å®Œå–„ |\\n| å®‰å…¨æ€§ | â­â­â­â˜†â˜† | âš ï¸ éœ€æ”¹è¿› | ç¼ºå°‘è¾“å…¥éªŒè¯ |\\n\\n---\\n\\n## ğŸ” ä»£ç å¤æ‚åº¦åˆ†æ\\n\\n### è¯„ä¼°ç»“æœ\\n\\n- **ä»£ç ç»“æ„**ï¼šæ•´ä½“ç»“æ„æ¸…æ™°ï¼Œæ¨¡å—åˆ’åˆ†åˆç†\\n- **é€»è¾‘å¤æ‚åº¦**ï¼šéƒ¨åˆ†å‡½æ•°å­˜åœ¨åµŒå¥—è¿‡æ·±çš„é—®é¢˜\\n- **å¯è¯»æ€§**ï¼šå˜é‡å‘½åè§„èŒƒï¼Œæ³¨é‡Šå……åˆ†\\n\\n### ğŸ’¡ æ”¹è¿›å»ºè®®\\n\\n> å»ºè®®å°† \`processData\` å‡½æ•°æ‹†åˆ†ä¸ºæ›´å°çš„å‡½æ•°ï¼Œé™ä½åœˆå¤æ‚åº¦ã€‚\\n\\n---\\n\\n## âœ… å¯è¡Œæ€§è¯„ä¼°\\n\\n### å®ç°åˆç†æ€§\\n\\n| æ£€æŸ¥é¡¹ | ç»“æœ | è¯´æ˜ |\\n|--------|------|------|\\n| é€»è¾‘æ­£ç¡®æ€§ | âœ… é€šè¿‡ | æ ¸å¿ƒé€»è¾‘å®ç°æ­£ç¡® |\\n| è¾¹ç•Œå¤„ç† | âœ… é€šè¿‡ | å·²è€ƒè™‘è¾¹ç•Œæƒ…å†µ |\\n| æ€§èƒ½è€ƒè™‘ | âš ï¸ éƒ¨åˆ† | å¤§æ•°æ®é‡æ—¶å¯èƒ½å­˜åœ¨æ€§èƒ½ç“¶é¢ˆ |\\n\\n### æ½œåœ¨é—®é¢˜\\n\\n1. ç¼ºå°‘å¯¹ç©ºå€¼çš„å¤„ç†\\n2. å¼‚å¸¸å¤„ç†ä¸å¤Ÿå®Œå–„\\n\\n---\\n\\n## ğŸ”’ å®‰å…¨æ€§æ£€æŸ¥\\n\\n| æ£€æŸ¥é¡¹ | çŠ¶æ€ | é£é™©ç­‰çº§ | è¯´æ˜ |\\n|--------|------|----------|------|\\n| SQL æ³¨å…¥ | âœ… å®‰å…¨ | - | ä½¿ç”¨äº†å‚æ•°åŒ–æŸ¥è¯¢ |\\n| XSS é˜²æŠ¤ | âš ï¸ éœ€æ”¹è¿› | ä¸­ | ç¼ºå°‘è¾“å‡ºè½¬ä¹‰ |\\n| è¾“å…¥éªŒè¯ | âŒ ç¼ºå¤± | é«˜ | æœªå¯¹ç”¨æˆ·è¾“å…¥è¿›è¡ŒéªŒè¯ |\\n| æƒé™éªŒè¯ | âœ… å®‰å…¨ | - | æƒé™æ£€æŸ¥å®Œå–„ |\\n\\n### å®‰å…¨å»ºè®®\\n\\n> ğŸ”’ **é‡è¦**ï¼šå»ºè®®æ·»åŠ è¾“å…¥éªŒè¯å’Œè¾“å‡ºè½¬ä¹‰ï¼Œé˜²æ­¢ XSS æ”»å‡»ã€‚\\n\\n---\\n\\n## ğŸ“ æ€»ä½“è¯„ä»·\\n\\n### ç»¼åˆè¯„åˆ†ï¼šâ­â­â­â­â˜† (4/5)\\n\\n**ä¼˜ç‚¹ï¼š**\\n- ä»£ç ç»“æ„æ¸…æ™°ï¼Œé€»è¾‘åˆç†\\n- æ ¸å¿ƒåŠŸèƒ½å®ç°æ­£ç¡®\\n\\n**éœ€è¦æ”¹è¿›ï¼š**\\n- åŠ å¼ºå®‰å…¨æ€§é˜²æŠ¤\\n- ä¼˜åŒ–æ€§èƒ½ç“¶é¢ˆ\\n\\n**å»ºè®®ï¼š**\\n1. æ·»åŠ è¾“å…¥éªŒè¯å’Œè¾“å‡ºè½¬ä¹‰\\n2. ä¼˜åŒ–å¤§æ•°æ®é‡å¤„ç†é€»è¾‘\\n3. å®Œå–„å¼‚å¸¸å¤„ç†æœºåˆ¶\\n",
  "lineComments": [
    {
      "path": "src/example.ts",
      "line": 42,
      "position": 15,
      "comment": "è¿™é‡Œå¯èƒ½å­˜åœ¨ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œå»ºè®®æ·»åŠ ç©ºå€¼æ£€æŸ¥",
      "severity": "warning"
    }
  ]
}
\`\`\`

## è¾“å‡ºè¦æ±‚æ€»ç»“

1. **analysisReport å¿…é¡»æ˜¯æ ¼å¼ä¼˜ç¾çš„ Markdown æ–‡æ¡£**ï¼ŒåŒ…å«ï¼š
   - ä½¿ç”¨è¡¨æ ¼å±•ç¤ºè¯„åˆ†å’Œæ£€æŸ¥é¡¹
   - ä½¿ç”¨ä»£ç å—ã€å¼•ç”¨å—ã€åˆ—è¡¨ç­‰ Markdown å…ƒç´ 
   - ä½¿ç”¨ emoji å¢å¼ºå¯è¯»æ€§ï¼ˆå¯é€‰ï¼‰
   - ä½¿ç”¨åˆ†éš”çº¿åŒºåˆ†ç« èŠ‚
   - ä¿æŒå±‚æ¬¡æ¸…æ™°ï¼Œç»“æ„å®Œæ•´

2. **å†…å®¹è¦æ±‚**ï¼š
   - å¿…é¡»åŒ…å«ï¼šå¤æ‚åº¦åˆ†æã€å¯è¡Œæ€§è¯„ä¼°ã€å®‰å…¨æ€§æ£€æŸ¥ã€æ€»ä½“è¯„ä»·å››ä¸ªéƒ¨åˆ†
   - æ¯ä¸ªéƒ¨åˆ†éƒ½è¦æœ‰å…·ä½“çš„åˆ†æå’Œå»ºè®®
   - ä½¿ç”¨è¡¨æ ¼ã€åˆ—è¡¨ç­‰æ ¼å¼è®©å†…å®¹æ›´æ˜“è¯»

3. **å¦‚æœä»£ç æ²¡æœ‰é—®é¢˜ï¼ŒlineComments å¯ä»¥ä¸ºç©ºæ•°ç»„ []**

4. **severity åªèƒ½æ˜¯ "error"ã€"warning" æˆ– "info" ä¹‹ä¸€**

5. **è¯·ç¡®ä¿è¾“å‡ºçš„ JSON æ ¼å¼å®Œå…¨åˆæ³•ï¼Œå¯ä»¥è¢« JSON.parse() è§£æ**

6. **æ³¨æ„è½¬ä¹‰å­—ç¬¦**ï¼šåœ¨ JSON å­—ç¬¦ä¸²ä¸­ï¼Œæ¢è¡Œç¬¦ä½¿ç”¨ \\nï¼Œå¼•å·ä½¿ç”¨ \\"

7. **GitLab diff æ ¼å¼çš„ position è®¡ç®—**ï¼š
   - å¿…é¡»è·³è¿‡ "æ–‡ä»¶ï¼šxxx (status)" è¿™æ ·çš„æ–‡ä»¶å¤´éƒ¨è¡Œ
   - å¿…é¡»è·³è¿‡ "@@ -x,y +x,y @@" è¿™æ ·çš„ diff æ ‡è®°è¡Œ
   - å¿…é¡»è·³è¿‡ "\\ No newline at end of file" è¿™æ ·çš„å…ƒæ•°æ®è¡Œ
   - å¿…é¡»è·³è¿‡ç©ºè¡Œ
   - åªè®¡ç®—å®é™…çš„ä»£ç è¡Œï¼ˆä»¥ "+"ã€"-" å¼€å¤´çš„è¡Œï¼Œæˆ–ä¸Šä¸‹æ–‡ä»£ç è¡Œï¼‰`;
  }

  /**
   * è®¡ç®— GitLab diff æ ¼å¼ä¸­æŒ‡å®šè¡Œçš„ position
   * è¿™ä¸ªæ–¹æ³•ç”¨äºéªŒè¯æˆ–è¾…åŠ©è®¡ç®— positionï¼Œå®é™…è®¡ç®—åº”è¯¥ç”± AI æ ¹æ® prompt ä¸­çš„è¯´æ˜è¿›è¡Œ
   * @param diff å®Œæ•´çš„ diff å­—ç¬¦ä¸²
   * @param filePath æ–‡ä»¶è·¯å¾„ï¼ˆæ ¼å¼ï¼šæ–‡ä»¶ï¼špath/to/file.ts (status)ï¼‰
   * @param lineNumber æ–‡ä»¶ä¸­çš„è¡Œå·ï¼ˆæ–°æ–‡ä»¶ä¸­çš„è¡Œå·ï¼‰
   * @returns position åœ¨ diff ä¸­çš„ä½ç½®ç´¢å¼•ï¼ˆä» 1 å¼€å§‹ï¼‰ï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ™è¿”å› -1
   */
  static calculatePosition(
    diff: string,
    filePath: string,
    lineNumber: number,
  ): number {
    const lines = diff.split('\n');
    let position = 0;
    let inFileDiff = false;
    let targetFileFound = false;
    let currentFileLineNumber = 0;

    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];

      // æ£€æµ‹æ–‡ä»¶å¤´éƒ¨è¡Œï¼ˆå¦‚ "æ–‡ä»¶ï¼š33.md (modified)"ï¼‰
      if (line.startsWith('æ–‡ä»¶ï¼š')) {
        // å¦‚æœæ‰¾åˆ°äº†ç›®æ ‡æ–‡ä»¶ï¼Œä¸”å·²ç»å¤„ç†å®Œï¼Œå¯ä»¥æå‰é€€å‡º
        if (targetFileFound && currentFileLineNumber >= lineNumber) {
          break;
        }

        inFileDiff = false;
        targetFileFound =
          line === filePath ||
          line.startsWith(`æ–‡ä»¶ï¼š${filePath.replace('æ–‡ä»¶ï¼š', '')}`);
        // position ä¸é‡ç½®ï¼Œä¿æŒå…¨å±€è¿ç»­
        currentFileLineNumber = 0;
        continue;
      }

      // å¦‚æœè¿˜æ²¡æœ‰è¿›å…¥å½“å‰æ–‡ä»¶çš„ diff
      if (!inFileDiff) {
        // æ£€æµ‹åˆ° @@ è¡Œï¼Œè¡¨ç¤ºå¼€å§‹è¿›å…¥ diff å†…å®¹
        if (line.startsWith('@@')) {
          inFileDiff = true;
          // è§£ææ–°æ–‡ä»¶çš„èµ·å§‹è¡Œå·
          const match = line.match(
            /@@\s*-(\d+)(?:,(\d+))?\s*\+(\d+)(?:,(\d+))?\s*@@/,
          );
          if (match && targetFileFound) {
            currentFileLineNumber = parseInt(match[3], 10) - 1; // new_startï¼Œå‡1å› ä¸ºåé¢ä¼šå…ˆ++
          }
        }
        continue;
      }

      // è·³è¿‡ diff æ ‡è®°è¡Œï¼ˆ@@ å¼€å¤´ï¼‰
      if (line.startsWith('@@')) {
        // é‡æ–°è§£æè¡Œå·
        const match = line.match(
          /@@\s*-(\d+)(?:,(\d+))?\s*\+(\d+)(?:,(\d+))?\s*@@/,
        );
        if (match && targetFileFound) {
          currentFileLineNumber = parseInt(match[3], 10) - 1;
        }
        continue;
      }

      // è·³è¿‡å…ƒæ•°æ®è¡Œï¼ˆ\ å¼€å¤´ï¼Œå¦‚ "\ No newline at end of file"ï¼‰
      if (line.startsWith('\\')) {
        continue;
      }

      // è·³è¿‡ç©ºè¡Œ
      if (line.trim() === '') {
        continue;
      }

      // è®¡ç®—å®é™…ä»£ç è¡Œçš„ positionï¼ˆåªè®¡ç®—ç›®æ ‡æ–‡ä»¶çš„è¡Œï¼‰
      if (targetFileFound) {
        position++;

        // æ ¹æ®è¡Œç±»å‹æ›´æ–°æ–‡ä»¶è¡Œå·
        if (line.startsWith('+')) {
          // æ–°å¢è¡Œ
          currentFileLineNumber++;
          if (currentFileLineNumber === lineNumber) {
            return position;
          }
        } else if (line.startsWith('-')) {
          // åˆ é™¤è¡Œï¼Œä¸å¢åŠ æ–°æ–‡ä»¶è¡Œå·ï¼Œä½† position éœ€è¦è®¡ç®—
          // åˆ é™¤è¡Œé€šå¸¸ä¸ç”¨äºè¯„è®ºï¼Œä½†ä¸ºäº†å®Œæ•´æ€§ä¹Ÿè®¡ç®— position
        } else {
          // ä¸Šä¸‹æ–‡è¡Œ
          currentFileLineNumber++;
          // ä¸Šä¸‹æ–‡è¡Œé€šå¸¸ä¸ç”¨äºè¯„è®º
        }
      } else {
        // å¦‚æœä¸æ˜¯ç›®æ ‡æ–‡ä»¶ï¼Œä¹Ÿéœ€è¦è®¡ç®— positionï¼ˆå› ä¸º position æ˜¯å…¨å±€çš„ï¼‰
        position++;
      }
    }

    return -1; // æœªæ‰¾åˆ°
  }

  /**
   * è§£æ GitLab diff æ ¼å¼ï¼Œè¿”å›æ¯ä¸ªä»£ç è¡Œçš„ position æ˜ å°„
   * position æ˜¯å…¨å±€çš„ï¼Œè·¨æ‰€æœ‰æ–‡ä»¶è®¡ç®—
   * @param diff å®Œæ•´çš„ diff å­—ç¬¦ä¸²
   * @returns Map<æ–‡ä»¶è·¯å¾„, Map<è¡Œå·, position>>
   */
  static parseDiffPositions(diff: string): Map<string, Map<number, number>> {
    const result = new Map<string, Map<number, number>>();
    const lines = diff.split('\n');
    let currentFile = '';
    let currentFilePositions = new Map<number, number>();
    let position = 0; // å…¨å±€ positionï¼Œè·¨æ‰€æœ‰æ–‡ä»¶
    let inFileDiff = false;
    let fileLineNumber = 0; // æ–‡ä»¶ä¸­çš„å®é™…è¡Œå·ï¼ˆä» diff çš„ @@ è¡Œä¸­è§£æï¼‰

    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];

      // æ£€æµ‹æ–‡ä»¶å¤´éƒ¨è¡Œ
      if (line.startsWith('æ–‡ä»¶ï¼š')) {
        // ä¿å­˜ä¸Šä¸€ä¸ªæ–‡ä»¶çš„ç»“æœ
        if (currentFile) {
          result.set(currentFile, currentFilePositions);
        }
        // å¼€å§‹æ–°æ–‡ä»¶
        currentFile = line;
        currentFilePositions = new Map<number, number>();
        // position ä¸é‡ç½®ï¼Œä¿æŒå…¨å±€è¿ç»­
        inFileDiff = false;
        fileLineNumber = 0;
        continue;
      }

      // å¦‚æœè¿˜æ²¡æœ‰è¿›å…¥å½“å‰æ–‡ä»¶çš„ diff
      if (!inFileDiff) {
        // æ£€æµ‹åˆ° @@ è¡Œï¼Œè§£æèµ·å§‹è¡Œå·
        if (line.startsWith('@@')) {
          inFileDiff = true;
          // è§£æ @@ -old_start,old_count +new_start,new_count @@
          const match = line.match(
            /@@\s*-(\d+)(?:,(\d+))?\s*\+(\d+)(?:,(\d+))?\s*@@/,
          );
          if (match) {
            fileLineNumber = parseInt(match[3], 10) - 1; // new_startï¼Œå‡1å› ä¸ºåé¢ä¼šå…ˆ++
          }
          continue;
        }
        continue;
      }

      // è·³è¿‡ diff æ ‡è®°è¡Œ
      if (line.startsWith('@@')) {
        // é‡æ–°è§£æè¡Œå·
        const match = line.match(
          /@@\s*-(\d+)(?:,(\d+))?\s*\+(\d+)(?:,(\d+))?\s*@@/,
        );
        if (match) {
          fileLineNumber = parseInt(match[3], 10) - 1;
        }
        continue;
      }

      // è·³è¿‡å…ƒæ•°æ®è¡Œ
      if (line.startsWith('\\')) {
        continue;
      }

      // è·³è¿‡ç©ºè¡Œ
      if (line.trim() === '') {
        continue;
      }

      // è®¡ç®—å®é™…ä»£ç è¡Œçš„ positionï¼ˆå…¨å±€ï¼‰
      position++;

      // æ ¹æ®è¡Œç±»å‹æ›´æ–°æ–‡ä»¶è¡Œå·
      if (line.startsWith('+')) {
        // æ–°å¢è¡Œï¼Œåªåœ¨æ–°æ–‡ä»¶ä¸­å­˜åœ¨
        fileLineNumber++;
        currentFilePositions.set(fileLineNumber, position);
      } else if (line.startsWith('-')) {
        // åˆ é™¤è¡Œï¼Œåªåœ¨æ—§æ–‡ä»¶ä¸­å­˜åœ¨ï¼Œä¸å¢åŠ æ–°æ–‡ä»¶è¡Œå·
        // åˆ é™¤è¡Œé€šå¸¸ä¸ç”¨äºè¯„è®ºï¼Œä½†ä¸ºäº†å®Œæ•´æ€§ä¹Ÿå¯ä»¥è®°å½• position
        // è¿™é‡Œä¸è®°å½•ï¼Œå› ä¸º lineNumber æ˜¯åŸºäºæ–°æ–‡ä»¶çš„
      } else {
        // ä¸Šä¸‹æ–‡è¡Œï¼Œä¸¤ä¸ªæ–‡ä»¶éƒ½å­˜åœ¨
        fileLineNumber++;
        // ä¸Šä¸‹æ–‡è¡Œé€šå¸¸ä¸éœ€è¦è¯„è®ºï¼Œä½†ä¹Ÿå¯ä»¥è®°å½•
      }
    }

    // ä¿å­˜æœ€åä¸€ä¸ªæ–‡ä»¶çš„ç»“æœ
    if (currentFile) {
      result.set(currentFile, currentFilePositions);
    }

    return result;
  }
}
